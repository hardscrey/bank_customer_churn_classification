# bank_customer_churn_classification

**Цели проекта:**
- Провести анализ клиентской базы банка и построить модель, предсказывающую, покинет ли клиент банк;
- Выявить признаки, влияющих на отток, и создать модель, которую можно использовать для повышения удержания клиентов.

**Основные задачи:**
- Подготовка и предобработка данных
- Исследовательский анализ данных (EDA)
- Обучение моделей
- Оценка моделей
- Определение и анализ значимых признаков
- Формулировка рекомендаций для снижения оттока

Все артефакты сохраняются в [`images/`](images/), [`models/`](models/) и [`model_comparison/`](model_comparison/).

Переход к [**Ноутбуку**](bank_customer_churn_prediction.ipynb)

---

## Используемые библиотеки
`pandas`, `numpy`, `matplotlib`, `seaborn`, `warnings`, `statsmodels`, `scikit-learn`, `xgboost`, `phik`, `shap`, `joblib`

---

## 1. Подготовка и предобработка данных
- Источник: [**Churn Modelling**](data/README.md)
- Загружены данные, проверена структура и типы признаков.  
- Исключены неинформативные столбцы: `RowNumber`, `CustomerId`, `Surname`.  
- Закодированы категориальные переменные: `Geography` и `Gender`.  
- Добавлен новый признак **BalanceGeoDiff** — разница между балансом клиента и средним балансом по его стране.  
- Проверены пропущенные значения и дубликаты.
- Проведена балансировка классов - целевая переменная `Exited` несбалансирована (~20% клиентов покидают банк).  

---

## 2. Исследовательский анализ данных (EDA)

**Корреляции**
Для смешанных типов данных использована **phik-корреляция**, которая лучше учитывает нелинейные и категориальные зависимости.

Наибольшая зависимость с оттоком наблюдается у признаков **Age**, **NumOfProducts**, **IsActiveMember** и **BalanceGeoDiff**.

![](images/phik_correlation.png)

**Анализ распределений и взаимосвязей признаков показал ряд закономерностей:**

- **Возраст**: вероятность оттока увеличивается после 40 лет.

![](images/age_distribution.png)

- **Количество продуктов (NumOfProducts)**: клиенты с 3–4 продуктами чаще уходят.

![](images/numofproducts_count.png)

- **Активность клиента (IsActiveMember)**: активные пользователи остаются дольше.

![](images/active_by_exited.png)

- **Доход и баланс**: клиенты с аномально высоким балансом относительно среднего по стране склонны к оттоку.

![](images/balancegeodiff_distribution.png)

---

## 3. Обучение моделей

Было  проведено масштабирование данных и разделение на выборки для обучения: Train/test shapes: (2851, 11) (1223, 11)

Были протестированы три модели:

1. **Logistic Regression** — базовый линейный классификатор.  
2. **Random Forest** — ансамблевая модель, хорошо работающая с нелинейными зависимостями.  
3. **XGBoost** — градиентный бустинг, показывающий оптимальный баланс точности и обобщающей способности.

| model              | train_acc | test_acc | train_auc | test_auc |
|--------------------|-----------|----------|-----------|----------|
| LogisticRegression | 0.697     | 0.718    | 0.697     | 0.718    |
| RandomForest       | 1.000     | 0.789    | 1.000     | 0.789    |
| XGBoost            | 0.990     | 0.769    | 0.990     | 0.769    |

---

## 4. Оценка моделей

Для каждой модели проведён подбор гиперпараметров с помощью **GridSearchCV**, после чего была выбрана луяшая модель на основе графиков и сравнения характеристик:

Метрики использованные для оценки:
- **Accuracy** — общая доля правильных предсказаний.
- **Precision** — точность среди предсказанных уходов.
- **Recall** — доля верно найденных уходящих клиентов.
- **F1-score** — гармоническое среднее Precision и Recall.
- **AUC ROC** — качество разделения классов.

[Сравнение основных характеристи моделей](model_comparison/final_model_metrics.csv)

| model             | train_accuracy | test_accuracy | train_precision | test_precision | train_recall | test_recall | train_f1 | test_f1 | train_auc | test_auc |
|-------------------|----------------|---------------|-----------------|----------------|--------------|-------------|----------|---------|-----------|----------|
| Best_RandomForest | 0.831          | 0.786         | 0.854           | 0.805          | 0.799        | 0.755       | 0.826    | 0.779   | 0.914     | 0.873    |
| Best_XGBoost      | 0.805          | 0.786         | 0.822           | 0.798          | 0.779        | 0.764       | 0.800    | 0.781   | 0.892     | 0.874    |

**ROC-кривые** — показывают зависимость True Positive Rate от False Positive Rate.  
График сравнения ROC-кривых:

![](images/roc_comparison.png)

XGBoost имеет наибольшую площадь под ROC-кривой (AUC), что указывает на лучшую способность модели отличать уходящих клиентов.

**Precision-Recall кривые** — демонстрируют соотношение точности и полноты при различных порогах вероятности.
График сравнения Precision-Recall-кривых:

![](images/pr_comparison.png)

На PR-графике видно, что XGBoost сохраняет высокую точность даже при повышенном Recall, что важно для задач удержания клиентов.

**Лучшая модель — XGBoost**: Она сочетает высокую точность и устойчивость, показывая сбалансированные результаты между train/test.

---

## 5. Confusion Matrix и Classification Report

Построена **матрица ошибок** для лучшей модели (XGBoost):

![](images/confusion_matrix_best.png)

Таблица **Classification Report**

|              | precision | recall | f1-score | support |
|--------------|-----------|--------|----------|---------|
|              |           |        |          |         |
| 0            | 0.77      | 0.81   | 0.79     | 612     |
| 1            | 0.80      | 0.76   | 0.78     | 611     |
|              |           |        |          |         |
| accuracy     |           |        | 0.79     | 1223    |
| macro avg    | 0.79      | 0.79   | 0.79     | 1223    |
| weighted avg | 0.79      | 0.79   | 0.79     | 1223    |

Интерпретация:
- Модель правильно распознаёт около 77% клиентов, склонных к уходу, что делает её полезной для прогнозов удержания.  
- При этом уровень ложных срабатываний остаётся умеренным.

---

## 6. Интерпретация модели (Feature importance и SHAP-анализ)

Feature importance определяет степень влиния каждого признака на отток:

![](images/feature_importance.png)

Для объяснимости лучшей модели (XGBoost) проведён анализ с помощью **SHAP**.  
SHAP-значения показывают, как каждый признак влияет на вероятность оттока конкретного клиента.

![](images/shap_summary.png)

**Ключевые факторы:**
- `Age` — старшие клиенты имеют повышенный риск ухода.  
- `NumOfProducts` — более 2 продуктов увеличивают риск ухода.  
- `IsActiveMember` — активность клиента снижает вероятность оттока.  
- `BalanceGeoDiff` — значительное отклонение баланса от среднего по стране увелиыивает рис оттока.

SHAP dependence от Возраста и Количества продуктов более подробно показывает зависимости признаков и их влияние:

График зависимости SHAP для Возраста показывает наличие взаимосвязи с Активностью, а также что с увеличением возраста (>40 лет) риск оттока увеличивается, при этом Активность клиента способна уменьшить влияние возраста.

![](images/shap_dependence_Age.png)

График зависимости SHAP для Количества прдуктов показывает наличие взаимосвязи с Разницей баланса по стране и смягчающее влияние этого показателя на клиентов с 1 и 2 продуктами.

![](images/shap_dependence_NumOfProducts.png)

---

## 7. Финальные результаты и инсайты

| Фактор | Влияние на отток | Бизнес-интерпретация |
|---------|------------------|----------------------|
| **Возраст** | Увеличивает риск | Клиенты старше 40 лет — целевая группа для удержания |
| **Количество продуктов** |  Нелинейное влияние | Пересмотреть продуктовую политику для клиентов с 3–4 продуктами |
| **Активность** | Снижает риск | Усиливать вовлечённость через активности и программы лояльности для возрастных клиентов |
| **Баланс** | Высокий баланс повышает риск | Анализировать “богатых, но неактивных” клиентов |

**Итоговые выводы**
- Модель XGBoost обеспечивает наилучший результат.  
- Основные признаки риска оттока — **возраст**, **активность**, **число продуктов**, **финансовый баланс**.  
- SHAP-анализ подтвердил интерпретируемость модели и выявил закономерности поведения клиентов.  
- Рекомендовано использовать модель для **раннего предупреждения об уходе** и **разработки таргетированных кампаний удержания**.
